---
title: "RunSensyAnalysisSims_Crop2ML_SoilTemp"
author: "RCichota"
date: "`r Sys.Date()`"
output: html_document
---


# Running simulations with soil temperature models from Crop2ML in R - sensitivity analysis set

This scripts aim to run a series of soil temperature models generated using Crop2ML for the R environment.
These runs simulate soil temperature over a range of scenarios designed to meet two basic objectives:
 - Test whether Crop2ML generated the code for the various models appropriately (i.e. the results from re-runs match the set of reference values, produced in the native code);
 - Produce data for model inter-comparison and a sensitivity analysis. For this, the scenarios cover a wide range of climatic and edaphic conditions, and simulations run over 30 years. 
Further details on factors and methodology for the sensitivity analysis run can be found at: https://drive.google.com/drive/folders/1-JI2jezJ23MF5twc9kRFLU9SD7IJugoQ

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load some libraries
library(here)
library(gsubfn)
library(dplyr)
library(lubridate)
library(ggplot2)

# load the BioMA-Parton component
source(here("Crop2ML", "BiomaSurfacePartonSoilSWATC", "SurfacePartonSoilSWATCComponent.r"))

# load the BioMA-SWAT component
source(here("Crop2ML", "BiomaSurfaceSWATSoilSWATC", "SurfaceSWATSoilSWATCComponent.r"))

# load DSSAT-EPIC component
source(here("Crop2ML", "DSSAT_EPICST_standalone", "STEMP_EPIC_Component.r"))

# load the DSSAT native component
source(here("Crop2ML", "DSSAT_ST_standalone", "STEMP_Component.r"))

# load the MONICA component
source(here("Crop2ML", "Monica_SoilTemp", "SoilTemperatureCompComponent.r"))

# load the SIMPLACE component
source(here("Crop2ML","Simplace_Soil_Temperature", "SoilTemperatureComponent.r"))

# load the SiriusQuality component
source(here("Crop2ML", "SQ_Soil_Temperature", "SoilTemperatureComponent.r"))

# load the STICS component
source(here("Crop2ML", "Stics_soil_temperature", "soil_tempComponent.r"))

# load auxiliary functions
source(here("auxiliary", "MapLayerValues.R"))

```

## Experiment setup

The scenarios for which each model will be run comprise the following factors:
 - Weather data from seven location around the world (Gainesville, FL, USA; MÃ¼ncheberg, Germany; Cali, Colombia; Lusignan, France; Maricopa, AZ, USA; Montpellier, France; Quebec City, Canada);
 - Soil parameters for four standard soils (silty clay, silty loam, sandy loam, and sandy. Defined by the following layer structure: 0-5, 5-15, 15-30, 30-60, 60-90, 90-120, 120-150, 150-180, 180-210 cm);
 - Soil cover mimicking three LAI (leaf area index) levels (0, 2, and 7);
 - Five soil moisture levels, defined as fraction of available water content (0, 0.25, 0.5, 0.75, and 1.0);
All simulations are run continuously over 30 years and soil temperature (mean, minimum and maximum, if available) are recorded for each soil layer (including soil surface, if available). This should compound to 420 simulations for each model.
There are currently nine soil temperature models available to run in R: 
 - APSIM-Campbell (APC)*
 - BioMA-Parton   (PSC)
 - Bioma-SWAT     (SWC)
 - DSSAT-EPIC     (DEC)
 - DSSAT native   (DSC)
 - MONICA         (MOC)
 - SimPlace-APEX  (SAC)
 - SiriusQuality  (SQC)
 - STICS          (STC)
The weather data and soil parameters are given in text files (sourced and formatted by the DSSAT team), additional site and soil type specific are also recorded in text files, all in stored in the 'data' folder.

```{r experimentSettings}

# define the treatment levels for the experiment (IDs follow the order of sites, models, etc. given above)
modelsToRun <- c("APC", "PSC", "SWC", "DEC", "DSC", "MOC", "SAC", "SQC", "STC")
locationIDsToRun <- c("USGA", "DEMU", "COCA", "FRLU", "USMA", "FRMO", "CAQC")
soilsToRun <- c("SICL", "SILO", "SALO", "SAND")
laisToRun <- c(0, 2, 7)
pawsToRun <- c(0.0, 0.25, 0.5, 0.75, 1.0)

# define the temperature model to run
temperatureModel <- modelsToRun[7]
testToRun <- "One"

# define a selection of factors defining one experimental run
if (testToRun == "One")
{
  locationID <- locationIDsToRun[7]
  soilID <- soilsToRun[1]
  laiID <- laisToRun[3]
  pawID <- pawsToRun[3]
  run_SensitivityScenario(temperatureModel, locationID, soilID, laiID, pawID)
} else
{
  # run all experiments (combinations of location, soil, LAI, and PAW)
  #run_SensitivityExperiments(workingFolder, temperatureModel, locationIDsToRun, soilsToRun, laisToRun, pawsToRun)
}

```

## Setting up simulations

This is a function that takes the values defining one scenario (and model) and sets up the parameter set and inputs needed to run a simulation. The values needed are gathered from the text files in the 'data' folder. Finally, the outputs are formatted as required for the sensitivity analysis and saved in text files in the 'outputs' folder.
Note that the model will run over all dates in the weather file.

```{r simulationSettings}

run_SensitivityScenario <- function(temperatureModel, locationID, soilID, laiID, pawID )
{
  # get site data
  siteFilePath <- here("data", "WeatherMetadata.txt")
  sitesData <- read.table(siteFilePath, skip = 2, header = TRUE)
  siteData <- filter(sitesData, WST_ID == locationID)

  # get the weather data (daily values)
  weatherFilename <- paste0(locationID, "L", laiID, "AW", format(round(pawID,2), nsmall=2), ".WTH")
  weatherFilePath <- here("data", weatherFilename)
  weatherData <- read.table(weatherFilePath, header = TRUE)

  # get general soil data (soil type, etc)
  soilsFilePath <- here("data", "SoilMetadata.txt")
  soilsGeneralData <- read.table(soilsFilePath, skip = 2, header = TRUE)
  soilGeneralData <- filter(soilsGeneralData, SOIL_ID == soilID)

  # get soil profile data
  soilLayerFileName <- paste0("SoilLayers_", soilID, ".txt")
  soilLayerFilePath <- here("data", soilLayerFileName)
  soilLayerData <- read.table(soilLayerFilePath, skip = 2, header = TRUE)

  # set the value for soil water for the PAW treatment being simulated
  soilWaterToRun <- pawID*(soilLayerData$SLDUL - soilLayerData$SLLL) + soilLayerData$SLLL

  # set the value of biomass for the LAI treatment being simulated
  laisToRun <- c(0, 2, 7)
  biomassesToRun <- c(0.0, 1800.0, 10500.0)
  biomassCoverToRun <- list("LAI"=laiID, "biomassCover"=biomassesToRun[which(laisToRun==laiID)])

  # run one simulation
  if(temperatureModel=="APC")
  {
    outputData <- run_APCmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="PSC")
  {
    outputData <- run_PSCmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="SWC")
  {
    outputData <- run_SWCmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="DEC")
  {
    outputData <- run_DECmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="DSC")
  {
    outputData <- run_DSCmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="MOC")
  {
    outputData <- run_MOCmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="SAC")
  {
    outputData <- run_SACmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="SQC")
  {
    outputData <- run_SQCmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else
  if(temperatureModel=="STC")
  {
    outputData <- run_STCmodel(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterToRun, biomassCoverToRun)
  } else {
    cat("Model ", temperatureModel, " has not been implemented yet")
  }

  # save the outputs
  outputFileName <- paste0("SoilTemperature_RR_", temperatureModel, "_", locationID, "_", soilID, "_L", laiID, "_AW", format(round(pawID, 2), nsmall=2), ".txt")
  outputsFilePath <- here("outputs", outputFileName)
  write.table(outputData, outputsFilePath, sep="\t", row.names=FALSE, quote=FALSE)
}

```


## Run the DSSAT-EPIC model

This function takes the set of parameters and inputs needed to run the soil temperature model from DSSAT-EPIC, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation DSSAT-Epic model}

run_DECmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

 # define some variables specific to a given run/simulation
  doWater <- "Y"     # soil water switch
  
  # set model initialisation
  initialState <- init_stemp_epic(
    NL=nrow(soilLayerData),
    ISWWAT=doWater,
    BD=soilLayerData$SLBDM,
    DLAYR=soilLayerData$THICK,
    DS=soilLayerData$SLLB,
    DUL=soilLayerData$SLDUL,
    LL=soilLayerData$SLLL,
    NLAYR=nrow(soilLayerData),
    TAMP=siteData$TAMP,
    RAIN=weatherData$RAIN[1],
    SW=soilWaterData,
    TAVG=weatherData$T2M[1],
    TMAX=weatherData$TMAX[1],
    TMIN=weatherData$TMIN[1],
    TAV=siteData$TAV,
    DEPIR=0,
    BIOMAS=biomassCoverData$biomassCover,
    MULCHMASS=0,
    SNOW=weatherData$SNOW[1])

  # collect some variables that are needed on CalculateModel
  previousCUMDPT <- initialState$CUMDPT
  previousDSMID <- initialState$DSMID
  previousTDL <- initialState$TDL
  previousTMA <- initialState$TMA
  previousNDays <- initialState$NDays
  previousWetDay <- initialState$WetDay
  previousX2_PREV <- initialState$X2_PREV
  previousSRFTEMP <- initialState$SRFTEMP
  previousST <- initialState$ST

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_stemp_epic(
      BD=soilLayerData$SLBDM,
      RAIN=weatherData$RAIN[day],
      NDays=previousNDays,
      DEPIR=0,
      TMIN=weatherData$TMIN[day],
      WetDay=previousWetDay,
      DUL=soilLayerData$SLDUL,
      BIOMAS=biomassCoverData$biomassCover,
      DS=soilLayerData$SLLB,
      TAMP=siteData$TAMP,
      DLAYR =soilLayerData$THICK,
      MULCHMASS=0,
      LL=soilLayerData$SLLL,
      TDL=previousTDL,
      X2_PREV=previousX2_PREV,
      SW=soilWaterData,
      DSMID=previousDSMID,
      NLAYR=nrow(soilLayerData),
      TMAX=weatherData$TMAX[day],
      TAV=siteData$TAV,
      SNOW=weatherData$SNOW[day],
      TMA=previousTMA,
      TAVG=weatherData$T2M[day],
      SRFTEMP=previousSRFTEMP,
      ST=previousST,
      NL=nrow(soilLayerData),
      ISWWAT=doWater,
      CUMDPT=previousCUMDPT)

    # collect some variables that are needed for next iteration
    previousCUMDPT <- onProcessState$CUMDPT
    previousDSMID <- onProcessState$DSMID
    previousTDL <- onProcessState$TDL
    previousTMA <- onProcessState$TMA
    previousNDays <- onProcessState$NDays
    previousWetDay <- onProcessState$WetDay
    previousX2_PREV <- onProcessState$X2_PREV
    previousSRFTEMP <- onProcessState$SRFTEMP
    previousST <- onProcessState$ST

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c(round(onProcessState$SRFTEMP, 6), round(onProcessState$ST, 6)))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, rep("na", nrow(soilLayerData) + 1))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, rep("na", nrow(soilLayerData) + 1))
  }

  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMax, simulatedSoilTempMin)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```


## Run the DSSAT native model

This function takes the set of parameters and inputs needed to run the native soil temperature model from DSSAT, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation DSSAT native model}

run_DSCmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

 # define some variables specific to a given run/simulation
  doWater <- "Y"     # soil water switch

  # set model initialisation
  initialState <- init_stemp(
    NL=nrow(soilLayerData),
    ISWWAT=doWater,
    BD=soilLayerData$SLBDM,
    DLAYR=soilLayerData$THICK,
    DS=soilLayerData$SLLB,
    DUL=soilLayerData$SLDUL,
    LL=soilLayerData$SLLL,
    NLAYR=nrow(soilLayerData),
    MSALB=soilGeneralData$SALB,
    SRAD=weatherData$SRAD[1],
    SW=soilWaterData,
    TAVG=weatherData$T2M[1],
    TMAX=weatherData$TMAX[1],
    XLAT=siteData$XLAT,
    TAV=siteData$TAV,
    TAMP=siteData$TAMP,
    DOY=yday(as.Date(as.numeric(substr(weatherData$DATE[1], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[1], 1, 4), "-01-01")))))

  # collect some variables that are needed on CalculateModel
  previousCUMDPT <- initialState$CUMDPT
  previousDSMID <- initialState$DSMID
  previousTMA <- initialState$TMA
  previousTDL <- initialState$TDL
  previousATOT <- initialState$ATOT
  previousSRFTEMP <- initialState$SRFTEMP
  previousST <- initialState$ST

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_stemp_(
      TMAX=weatherData$TMAX[day],
      MSALB=soilGeneralData$SALB,
      HDAY=initialState$HDAY,
      NL=nrow(soilLayerData),
      SRFTEMP=previousSRFTEMP,
      LL=soilLayerData$SLLL,
      NLAYR=nrow(soilLayerData),
      DS=soilLayerData$SLLB,
      ST=previousST,
      SRAD=weatherData$SRAD[day],
      TAMP=siteData$TAMP,
      DLAYR=soilLayerData$THICK,
      TMA=previousTMA,
      TDL=previousTDL,
      ISWWAT=doWater,
      CUMDPT=previousCUMDPT,
      TAVG=weatherData$T2M[day],
      BD=soilLayerData$SLBDM,
      SW=soilWaterData,
      ATOT=previousATOT,
      TAV=siteData$TAV,
      XLAT=siteData$XLAT,
      DUL=soilLayerData$SLDUL,
      DSMID=previousDSMID,
      DOY=yday(as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))))
  
    # collect some variables that are needed for next iteration
    previousCUMDPT <- onProcessState$CUMDPT
    previousDSMID <- onProcessState$DSMID
    previousTMA <- onProcessState$TMA
    previousTDL <- onProcessState$TDL
    previousATOT <- onProcessState$ATOT
    previousSRFTEMP <- onProcessState$SRFTEMP
    previousST <- onProcessState$ST

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c(round(onProcessState$SRFTEMP, 6), round(onProcessState$ST, 6)))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, rep("na", nrow(soilLayerData) + 1))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, rep("na", nrow(soilLayerData) + 1))
  }

  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMax, simulatedSoilTempMin)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```


## Run the BioMA-Parton model

This function takes the set of parameters and inputs needed to run the Parton soil temperature model from BioMA, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation BioMA-Parton model}

run_PSCmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

  # set model initialisation
  initialState <- init_soiltemperatureswat(
    VolumetricWaterContent=soilWaterData,
    LayerThickness=soilLayerData$THICK/100.0,
    LagCoefficient=0.8,
    AirTemperatureAnnualAverage=siteData$TAV,
    BulkDensity=soilLayerData$SLBDM,
    SoilProfileDepth=sum(soilLayerData$THICK)/100.0)

  # collect some variables that are needed on CalculateModel
  previousST <- initialState$SoilTemperatureByLayers

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_surfacepartonsoilswatc(
      DayLength=weatherData$DAYLD[day],
      GlobalSolarRadiation=weatherData$SRAD[day],
      AboveGroundBiomass=biomassCoverData$biomassCover,
      AirTemperatureMinimum=weatherData$TMIN[day],
      AirTemperatureMaximum=weatherData$TMAX[day],
      LayerThickness=soilLayerData$THICK/100.0,
      BulkDensity=soilLayerData$SLBDM,
      SoilProfileDepth=sum(soilLayerData$THICK)/100.0,
      AirTemperatureAnnualAverage=siteData$TAV,
      VolumetricWaterContent=soilWaterData,
      LagCoefficient=0.8,
      preSoilTemperatureByLayers=previousST)

    # collect some variables that are needed for next iteration
    previousST <- onProcessState$SoilTemperatureByLayers

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c(round(onProcessState$SurfaceSoilTemperature, 6), round(onProcessState$SoilTemperatureByLayers, 6)))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, c(round(onProcessState$SurfaceTemperatureMaximum, 6), rep("na", nrow(soilLayerData))))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, c(round(onProcessState$SurfaceTemperatureMinimum, 6), rep("na", nrow(soilLayerData))))
  }

  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMax, simulatedSoilTempMin)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```


## Run the BioMA-SWAT model

This function takes the set of parameters and inputs needed to run the SWAT soil temperature model from BioMA, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation BioMA-SWAT model}

run_SWCmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

  # set model initialisation
  initialState <- init_soiltemperatureswat(
    VolumetricWaterContent=soilWaterData,
    LayerThickness=soilLayerData$THICK/100.0,
    LagCoefficient=0.8,
    AirTemperatureAnnualAverage=siteData$TAV,
    BulkDensity=soilLayerData$SLBDM,
    SoilProfileDepth=sum(soilLayerData$THICK)/100.0)

  # collect some variables that are needed on CalculateModel
  previousST <- initialState$SoilTemperatureByLayers

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_surfaceswatsoilswatc(
      AirTemperatureMaximum=weatherData$TMAX[day],
      AirTemperatureMinimum=weatherData$TMIN[day],
      GlobalSolarRadiation=weatherData$SRAD[day],
      AboveGroundBiomass=biomassCoverData$biomassCover,
      WaterEquivalentOfSnowPack=weatherData$SNOW[day],
      Albedo=soilGeneralData$SALB,
      BulkDensity=soilLayerData$SLBDM,
      AirTemperatureAnnualAverage=siteData$TAV,
      VolumetricWaterContent=soilWaterData,
      SoilProfileDepth=sum(soilLayerData$THICK)/100.0,
      LagCoefficient=0.8,
      LayerThickness=soilLayerData$THICK/100.0,
      preSoilTemperatureByLayers=previousST)

    # collect some variables that are needed for next iteration
    previousST <- onProcessState$SoilTemperatureByLayers

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c(round(onProcessState$SurfaceSoilTemperature, 6), round(onProcessState$SoilTemperatureByLayers, 6)))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, rep("na", nrow(soilLayerData) + 1))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, rep("na", nrow(soilLayerData) + 1))
  }
  
  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMax, simulatedSoilTempMin)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```


## Run the MONICA model

This function takes the set of parameters and inputs needed to run the soil temperature model from MONICA, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation MONICA model}

run_MOCmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

  # define some variables specific to a given run/simulation
  baseTemper <- 9.5        # base temperature
  airDensity <- 1.25       # density of air (kg/m3)
  airSpecHeat <- 1005.0    # specific heat capacity of air (J/kg/K)
  humusDensity <- 1300.0   # density of humus (kg/m3)
  humusSpecHeat <- 1920.0  # specific heat capacity of humus (J/kg/K)
  waterDensity <- 1000.0   # density of water (kg/m3)
  waterSpecHeat <- 4192.0  # specific heat capacity of water (J/kg/K)
  quartzDensity <- 2650.0  # density of quartz mineral (kg/m3)
  quartzSpecHeat <- 750.0  # specific heat capacity of quartz (J/kg/K)
  n_Tau <- 0.65            # a parameter (?)
  time_step <- 1.0         # time-step for calculations (-?)
  iniSurfaceTemp <-  10.0  # initial surface temperature
  dampingFactr <- 0.8      # a factor ??
  currentLAI <- biomassCoverData$LAI
  soilCover <- 1.0 - exp(-0.5 * currentLAI)
  hasSnow <- FALSE         # flag whether there is snow in the ground

  # re-map soil profile to MONICA requirements
  monicaSoilThickness <- rep(5.0, 42)
  currentSWC <- MapConcentrationByLayer(soilWaterData, soilLayerData$THICK, monicaSoilThickness)
  monicaBD <- MapConcentrationByLayer(soilLayerData$SLBDM*1000.0, soilLayerData$THICK, monicaSoilThickness)
  monicaSAT <- MapConcentrationByLayer(soilLayerData$SLSAT, soilLayerData$THICK, monicaSoilThickness)
  monicaOM <- MapConcentrationByLayer(soilLayerData$SLOC/(0.57*100.0), soilLayerData$THICK, monicaSoilThickness)
  monicaSoilThickness <- rep(0.05, 44)  # set values in m, add two extra layers, kept empty

  # set model initialisation
  initialState <- init_soiltemperature(
    noOfSoilLayers=length(monicaSoilThickness)-2,
    noOfTempLayers=length(monicaSoilThickness),
    noOfTempLayersPlus1=length(monicaSoilThickness)+1,
    timeStep=time_step,
    soilMoistureConst=currentSWC,
    baseTemp=baseTemper,
    initialSurfaceTemp=iniSurfaceTemp,
    densityAir=airDensity,
    specificHeatCapacityAir=airSpecHeat,
    densityHumus=humusDensity,
    specificHeatCapacityHumus=humusSpecHeat,
    densityWater=waterDensity,
    specificHeatCapacityWater=waterSpecHeat,
    quartzRawDensity=quartzDensity,
    specificHeatCapacityQuartz=quartzSpecHeat,
    nTau=n_Tau,
    layerThickness=monicaSoilThickness,
    soilBulkDensity=monicaBD,
    saturation=monicaSAT,
    soilOrganicMatter=monicaOM)

  # collect some variables that are needed on CalculateModel
  base_B <- initialState$B
  base_volumeMatrix <- initialState$volumeMatrix
  base_volumeMatrixOld <- initialState$volumeMatrixOld
  base_matrixPrimaryDiagonal <- initialState$matrixPrimaryDiagonal
  base_matrixSecondaryDiagonal <- initialState$matrixSecondaryDiagonal
  base_heatConductivityMean <- initialState$heatConductivityMean
  base_solution <- initialState$solution
  base_matrixDiagonal <- initialState$matrixDiagonal
  base_matrixLowerTriangle <- initialState$matrixLowerTriangle
  base_heatFlow <- initialState$heatFlow
  previousSurfaceTemperature <- initialState$soilSurfaceTemperature
  previousSoilTemperature <- initialState$soilTemperature

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_soiltemperaturecomp(
      tmin=weatherData$TMIN[day],
      tmax=weatherData$TMAX[day],
      globrad=weatherData$SRAD[day],
      dampingFactor=dampingFactr,
      soilCoverage=soilCover,
      soilSurfaceTemperatureBelowSnow=0,
      hasSnowCover=hasSnow,
#      timeStep=time_step,
#      soilMoistureConst=currentSWC,
#      baseTemp=baseTemper,
      initialSurfaceTemp=previousSurfaceTemperature,
#      densityAir=airDensity,
#      specificHeatCapacityAir=airSpecHeat,
#      densityHumus=humusDensity,
#      specificHeatCapacityHumus=humusSpecHeat,
#      densityWater=waterDensity,
#      specificHeatCapacityWater=waterSpecHeat,
#      quartzRawDensity=quartzDensity,
#      specificHeatCapacityQuartz=quartzSpecHeat,
#      nTau=n_Tau,
      noOfTempLayers=length(monicaSoilThickness),
      noOfTempLayersPlus1=length(monicaSoilThickness)+1,
      noOfSoilLayers=length(monicaSoilThickness)-2,
      layerThickness=monicaSoilThickness,
#      soilBulkDensity=monicaBD,
#      saturation=monicaSAT,
#      soilOrganicMatter=monicaOM,
      initialSoilTemperature=previousSoilTemperature,
#      V=base_V,
      B=base_B,
      volumeMatrix=base_volumeMatrix,
      volumeMatrixOld=base_volumeMatrixOld,
      matrixPrimaryDiagonal=base_matrixPrimaryDiagonal,
      matrixSecondaryDiagonal=base_matrixSecondaryDiagonal,
      heatConductivity=base_heatConductivity,
      heatConductivityMean=base_heatConductivityMean,
      heatCapacity=base_heatCapacity,
      solution=base_solution,
      matrixDiagonal=base_matrixDiagonal,
      matrixLowerTriangle=base_matrixLowerTriangle,
      heatFlow=base_heatFlow)

    # collect some variables that are needed for next iteration
    previousSurfaceTemperature <- onProcessState$soilSurfaceTemperature
    previousSoilTemperature <- onProcessState$soilTemperature

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    unMonicaSoilTemperature <- MapConcentrationByLayer(onProcessState$soilTemperature, monicaSoilThickness,soilLayerData$THICK/100.0)
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c(round(onProcessState$soilSurfaceTemperature, 6), round(unMonicaSoilTemperature, 6)))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, rep("na", nrow(soilLayerData) + 1))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, rep("na", nrow(soilLayerData) + 1))
  }

  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMin, simulatedSoilTempMax)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```


## Run the SimPlace-Apex model

This function takes the set of parameters and inputs needed to run the soil temperature model from SimPlace, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation SimPlace-Apex model}

run_SACmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

  # define some variables specific to a given run/simulation
  dampingDepth <- 6.0          # damping depth of soil
  snowIsolationFactorA = 2.3   # static part of the snow isolation index
  snowIsolationFactorB = 0.22  # dynamic part of the snow isolation index

  # set model initialisation
  initialStateSnow = init_snowcovercalculator(
    cCarbonContent=soilLayerData$SLOC[1],
    cInitialAgeOfSnow=0,
    cInitialSnowWaterContent=0,
    Albedo=soilGeneralData$SALB,
    cSnowIsolationFactorA=snowIsolationFactorA,
    cSnowIsolationFactorB=snowIsolationFactorB,
    iTempMax=weatherData$TMAX[1],
    iTempMin=weatherData$TMIN[1],
    iRadiation=weatherData$SRAD[1],
    iRAIN=weatherData$RAIN[1],
    iCropResidues=biomassCoverData$biomassCover,
    iPotentialSoilEvaporation=weatherData$ESP[1],
    iLeafAreaIndex=biomassCoverData$LAI,
    iSoilTempArray=rep(siteData$TAV, nrow(soilLayerData)))

  initialState = init_stmpsimcalculator(
    cSoilLayerDepth=soilLayerData$SLLB/100.0,
    cFirstDayMeanTemp=siteData$TAV,
    cAVT=siteData$TAV,
    cABD=soilGeneralData$SABDM,
    cDampingDepth=dampingDepth,
    iSoilWaterContent=sum(soilWaterData*soilLayerData$THICK*10.0),
    iSoilSurfaceTemperature)

  # collect some variables that are needed on CalculateModel
  baseInternalAlbedo <- initialStateSnow$pInternalAlbedo
  baseSoilLayerDepth <- initialState$pSoilLayerDepth
  previous_SnowWaterContent <- initialStateSnow$SnowWaterContent
  previous_SoilSurfaceTemperature<- initialStateSnow$SoilSurfaceTemperature
  previous_AgeOfSnow <- initialStateSnow$AgeOfSnow
  previous_SoilTempArray <- initialState$SoilTempArray
  previous_rSoilTempArrayRate <- initialState$rSoilTempArrayRate

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_soiltemperature(
      cCarbonContent=soilLayerData$SLOC[1],
      cAlbedo=soilGeneralData$SALB,
      iAirTemperatureMax=weatherData$TMAX[day],
      iAirTemperatureMin=weatherData$TMIN[day],
      iGlobalSolarRadiation=weatherData$SRAD[day],
      iRAIN=0.0,
      iCropResidues=0.0,
      iPotentialSoilEvaporation=weatherData$ESP[day],
      iLeafAreaIndex=biomassCoverData$LAI,
      SoilTempArray=previous_SoilTempArray,
      cSoilLayerDepth=soilLayerData$SLLB/100.0,
      cFirstDayMeanTemp=siteData$TAV,
      cAverageGroundTemperature=siteData$TAV,
      cAverageBulkDensity=soilGeneralData$SABDM,
      cDampingDepth=dampingDepth,
      iSoilWaterContent=sum(soilWaterData*soilLayerData$THICK*10.0),
      pInternalAlbedo=baseInternalAlbedo,
      SnowWaterContent=previous_SnowWaterContent,
      SoilSurfaceTemperature=previous_SoilSurfaceTemperature,
      AgeOfSnow=previous_AgeOfSnow,
      rSoilTempArrayRate=previous_rSoilTempArrayRate,
      pSoilLayerDepth=baseSoilLayerDepth,
      cInitialAgeOfSnow=0,
      cInitialSnowWaterContent=0,
      cSnowIsolationFactorA=snowIsolationFactorA,
      cSnowIsolationFactorB=snowIsolationFactorB)

    # collect some variables that are needed for next iteration
    previous_SoilSurfaceTemperature <- onProcessState$SoilSurfaceTemperature
    previous_SnowWaterContent <- onProcessState$SnowWaterContent
    previous_AgeOfSnow <- onProcessState$AgeOfSnow
    previous_SoilTempArray <- onProcessState$SoilTempArray
    previous_rSoilTempArrayRate <- onProcessState$rSoilTempArrayRate

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c(round(onProcessState$SoilSurfaceTemperature, 6), round(onProcessState$SoilTempArray[1:nrow(soilLayerData)], 6)))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, rep("na", nrow(soilLayerData) + 1))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, rep("na", nrow(soilLayerData) + 1))
  }
  
  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMax, simulatedSoilTempMin)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```


## Run the SiriusQuality model

This function takes the set of parameters and inputs needed to run the soil temperature model from SiriusQuality, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation SiriusQuality model}

run_SQCmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

  # define some variables specific to a given run/simulation
  lambda <-  2.454
  paramA <- 0.5
  paramB <- 1.8
  paramC <- 0.49

  # set model initialisation
  initialState <- init_calculatesoiltemperature(
    meanTAir=mean(weatherData$TMIN[1]+weatherData$TMAX[1]),
    minTAir=weatherData$TMIN[1],
    lambda_=lambda,
    meanAnnualAirTemp=siteData$TAV,
    maxTAir=weatherData$TMAX[1])
  
  # collect some variables that are needed on CalculateModel
  previousDeepLayerT <- initialState$deepLayerT

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_soiltemperature(
      meanTAir=weatherData$T2M[day],
      minTAir=weatherData$TMIN[day],
      lambda_=lambda,
      meanAnnualAirTemp=siteData$TAV,
      deepLayerT=previousDeepLayerT,
      heatFlux=0.0,  # to check
      maxTAir=weatherData$TMAX[day],
      b=paramB,
      c=paramC,
      a=paramA,
      dayLength=weatherData$DAYLD[day])

    # collect some variables that are needed for next iteration
    previousDeepLayerT <- onProcessState$deepLayerT

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c("na", round((onProcessState$minTSoil + onProcessState$maxTSoil)/2, 6), rep(round(onProcessState$deepLayerT, 6), nrow(soilLayerData)-1)))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, c("na",round(onProcessState$maxTSoil,6),rep("na", nrow(soilLayerData)-1)))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, c("na",round(onProcessState$minTSoil,6), rep("na", nrow(soilLayerData)-1)))
  }
  
  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMax, simulatedSoilTempMin)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```


## Run the STICS model

This function takes the set of parameters and inputs needed to run the soil temperature model from STICS, sets it appropriately and then collects the outputs and formats it in the require format for the sensitivity analysis exercise.

```{r runSimulation STICS model}

run_STCmodel <- function(siteData, soilGeneralData, soilLayerData, weatherData, soilWaterData, biomassCoverData)
{
  # initialise a series of variable to collect output of interest
  simulatedDate <- c()
  simulatedDepthTop <- c()
  simulatedDepthBtm <- c()
  simulatedSoilTempAve <- c()
  simulatedSoilTempMin <- c()
  simulatedSoilTempMax <- c()

  # set model initialisation
  initialState <- init_temp_profile(
    min_air_temp=weatherData$TMIN[1],
    air_temp_day1=weatherData$T2M[1],
    layer_thick=soilLayerData$THICK)

  # collect some variables that are needed on CalculateModel
  previousCanopy_temp <- initialState$prev_canopy_temp
  previousST <- initialState$prev_temp_profile

  # run model for the duration of the weather file
  for (day in 1:nrow(weatherData))
  {
    onProcessState <- model_soil_temp(
      min_temp=weatherData$TMIN[day],
      max_temp=weatherData$TMAX[day],
      prev_temp_profile=previousST,
      prev_canopy_temp=previousCanopy_temp,
      min_air_temp=weatherData$TMIN[day],
      air_temp_day1=weatherData$T2M[day],
      layer_thick=soilLayerData$THICK,
      min_canopy_temp=weatherData$TMIN[day],
      max_canopy_temp=weatherData$TMAX[day])

    # collect some variables that are needed for next iteration
  previousCanopy_temp <- onProcessState$prev_canopy_temp
  previousST <- onProcessState$prev_temp_profile

    # set date in correct format
    todaysDate <- as.Date(as.numeric(substr(weatherData$DATE[day], 5, 7)) - 1, as.Date(paste0(substr(weatherData$DATE[day], 1, 4), "-01-01")))

    # collect output data
    simulatedDate <- c(simulatedDate, rep(as.character(todaysDate), nrow(soilLayerData) + 1))
    simulatedDepthTop <- c(simulatedDepthTop, c(0.0, soilLayerData$SLLT))
    simulatedDepthBtm <- c(simulatedDepthBtm, c(0.0, soilLayerData$SLLB))
    simulatedSoilTempAve <- c(simulatedSoilTempAve, c("na", round(onProcessState$layer_temp, 6)))
    simulatedSoilTempMin <- c(simulatedSoilTempMin, rep("na", nrow(soilLayerData) + 1))
    simulatedSoilTempMax <- c(simulatedSoilTempMax, rep("na", nrow(soilLayerData) + 1))
  }

  # prepare the output table
  outputData <- data.frame(simulatedDate, simulatedDepthTop, simulatedDepthBtm, simulatedSoilTempAve, simulatedSoilTempMin, simulatedSoilTempMax)
  colnames(outputData) <- c("DATE", "SLLT", "SLLB", "TSLD", "TSLX", "TSLN")

  return(outputData)
}

```